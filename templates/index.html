{% extends "base.html" %}

{% block additional_styles %}
<style>
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .filter-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .filter-badge .close {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card" data-filter="all">
                <div class="card-body">
                    <h5 class="card-title">Total Instances</h5>
                    <h2 class="total-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="running">
                <div class="card-body">
                    <h5 class="card-title">Running Instances</h5>
                    <h2 class="running-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="resource-groups">
                <div class="card-body">
                    <h5 class="card-title">Resource Groups</h5>
                    <h2 class="resource-groups">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Resource Group</label>
                    <select class="form-select" id="resourceGroupFilter">
                        <option value="">All Resource Groups</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped</option>
                        <option value="deallocated">Deallocated</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>VM Size</label>
                    <select class="form-select" id="vmSizeFilter">
                        <option value="">All Sizes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Actions</label>
                    <div class="d-flex">
                        <button class="btn btn-primary me-2 flex-grow-1" id="applyFilters">
                            Apply Filters
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="clearFilters">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div id="activeFilters"></div>
            </div>
        </div>
    </div>

    <!-- Instances Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">Azure Instances</h5>
                <button class="btn btn-primary refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="table-responsive">
                <table id="instancesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Resource Group</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Location</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let table;
let activeFilters = {};

function updateActiveFilters() {
    const $container = $('#activeFilters');
    $container.empty();
    
    Object.entries(activeFilters).forEach(([key, value]) => {
        if (value) {
            const badge = `
                <span class="filter-badge">
                    ${key}: ${value}
                    <span class="close" data-filter="${key}">Ã—</span>
                </span>
            `;
            $container.append(badge);
        }
    });
}

function loadData() {
    startLoadingAnimation();
    
    // Build query parameters
    const params = new URLSearchParams();
    Object.entries(activeFilters).forEach(([key, value]) => {
        if (value) params.append(key, value);
    });
    
    $.get(`/api/instances?${params.toString()}`)
        .then(data => {
            if (data.error) {
                showToast(data.error, 'danger');
                return;
            }
            
            // Update stats
            $('.total-instances').text(data.totalCount);
            $('.running-instances').text(
                data.instances.filter(i => i.status.toLowerCase().includes('running')).length
            );
            $('.resource-groups').text(
                new Set(data.instances.map(i => i.resourceGroup)).size
            );
            
            // Update filters
            const resourceGroups = [...new Set(data.instances.map(i => i.resourceGroup))];
            const vmSizes = [...new Set(data.instances.map(i => i.size))];
            
            $('#resourceGroupFilter').find('option:gt(0)').remove();
            resourceGroups.forEach(rg => {
                $('#resourceGroupFilter').append(`<option value="${rg}">${rg}</option>`);
            });
            
            $('#vmSizeFilter').find('option:gt(0)').remove();
            vmSizes.forEach(size => {
                $('#vmSizeFilter').append(`<option value="${size}">${size}</option>`);
            });
            
            // Update table
            if (table) {
                table.clear().rows.add(data.instances).draw();
            } else {
                table = $('#instancesTable').DataTable({
                    data: data.instances,
                    columns: [
                        { data: 'name' },
                        { data: 'resourceGroup' },
                        {
                            data: 'status',
                            render: function(data) {
                                const status = data.toLowerCase();
                                let className = 'status-unknown';
                                if (status.includes('running')) className = 'status-running';
                                else if (status.includes('stopped') || status.includes('deallocated')) className = 'status-stopped';
                                return `<span class="status-badge ${className}">${data}</span>`;
                            }
                        },
                        { data: 'size' },
                        { data: 'location' },
                        {
                            data: 'tags',
                            render: function(data) {
                                return Object.entries(data || {})
                                    .map(([key, value]) => `<span class="tag-badge">${key}: ${value}</span>`)
                                    .join(' ');
                            }
                        }
                    ],
                    responsive: true,
                    dom: 'Bfrtip',
                    buttons: ['copy', 'excel', 'pdf'],
                    order: [[0, 'asc']]
                });
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showToast('Failed to load instance data', 'danger');
        })
        .finally(() => {
            stopLoadingAnimation();
        });
}

$(document).ready(function() {
    // Initialize filters
    $('#applyFilters').click(function() {
        activeFilters = {
            resource_group: $('#resourceGroupFilter').val(),
            status: $('#statusFilter').val(),
            vm_size: $('#vmSizeFilter').val()
        };
        updateActiveFilters();
        loadData();
    });
    
    $('#clearFilters').click(function() {
        activeFilters = {};
        $('#resourceGroupFilter, #statusFilter, #vmSizeFilter').val('');
        updateActiveFilters();
        loadData();
    });
    
    $(document).on('click', '.filter-badge .close', function() {
        const filter = $(this).data('filter');
        activeFilters[filter] = '';
        $(`#${filter}Filter`).val('');
        updateActiveFilters();
        loadData();
    });
    
    // Stats card filtering
    $('.stats-card').click(function() {
        const filter = $(this).data('filter');
        if (filter === 'all') {
            $('#clearFilters').click();
        } else if (filter === 'running') {
            $('#statusFilter').val('running');
            $('#applyFilters').click();
        }
    });
    
    // Initial load
    if (checkAzureLogin()) {
        loadData();
    }
    
    // Refresh button
    $('#refreshBtn').click(function() {
        loadData();
    });
});
</script>
{% endblock %}
