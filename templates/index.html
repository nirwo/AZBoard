{% extends "base.html" %}

{% block additional_styles %}
<style>
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .filter-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .filter-badge .close {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
    
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        z-index: 1000;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    #errorAlert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card" data-filter="all">
                <div class="card-body">
                    <h5 class="card-title">Total Instances</h5>
                    <h2 class="total-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="running">
                <div class="card-body">
                    <h5 class="card-title">Running Instances</h5>
                    <h2 class="running-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="resource-groups">
                <div class="card-body">
                    <h5 class="card-title">Resource Groups</h5>
                    <h2 class="resource-groups">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Resource Group</label>
                    <select class="form-select" id="resourceGroupFilter">
                        <option value="">All Resource Groups</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped</option>
                        <option value="deallocated">Deallocated</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>VM Size</label>
                    <select class="form-select" id="vmSizeFilter">
                        <option value="">All Sizes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Actions</label>
                    <div class="d-flex">
                        <button class="btn btn-primary me-2 flex-grow-1" id="applyFilters">
                            Apply Filters
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="clearFilters">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div id="activeFilters"></div>
            </div>
        </div>
    </div>

    <!-- Instances Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">Azure Instances</h5>
                <div>
                    <span class="me-3">Total Monthly Cost: <strong class="total-cost">$0.00</strong></span>
                    <button class="btn btn-primary refresh-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="instancesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Resource Group</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Network</th>
                            <th>Storage</th>
                            <th>Location</th>
                            <th>Monthly Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="vm-details"></div>
    
    <div id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <div id="errorAlert" class="alert alert-danger" role="alert"></div>

    <nav aria-label="VM pagination">
        <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
let table;
let currentPage = 1;
let totalPages = 1;
const perPage = 50;

function loadVMs(page = 1) {
    showLoading();
    
    fetch(`/api/vms?page=${page}&per_page=${perPage}`)
        .then(response => response.json())
        .then(data => {
            currentPage = data.page;
            totalPages = data.total_pages;
            
            // Update table
            if (table) {
                table.clear();
                table.rows.add(data.vms);
                table.draw();
            } else {
                initializeTable(data.vms);
            }
            
            // Update pagination
            updatePagination();
            
            // Load details for visible VMs
            loadVisibleVMDetails();
            
            hideLoading();
        })
        .catch(error => {
            console.error('Error loading VMs:', error);
            showError('Failed to load VM list');
            hideLoading();
        });
}

function updatePagination() {
    const pagination = document.getElementById('pagination');
    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
    </li>`;
    
    // Page numbers
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
        </li>`;
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
    </li>`;
    
    pagination.innerHTML = html;
}

function loadVisibleVMDetails() {
    const visibleRows = table.rows({ page: 'current' }).data();
    const vmBatch = [];
    
    visibleRows.each(vm => {
        vmBatch.push(`${vm.resourceGroup}/${vm.name}`);
    });
    
    if (vmBatch.length === 0) return;
    
    const queryString = vmBatch.map(vm => `vms[]=${encodeURIComponent(vm)}`).join('&');
    fetch(`/api/vms/batch?${queryString}`)
        .then(response => response.json())
        .then(data => {
            // Update VM details in the table
            visibleRows.each(vm => {
                const vmKey = `${vm.resourceGroup}/${vm.name}`;
                const details = data[vmKey];
                if (details) {
                    // Update network info
                    if (details.network) {
                        const privateIps = details.network.privateIpAddresses || [];
                        const publicIps = details.network.publicIpAddresses || [];
                        vm.privateIp = privateIps[0] || 'Not configured';
                        vm.publicIp = publicIps[0]?.ipAddress || 'Not configured';
                    }
                    
                    // Update other details as needed
                    if (details.vm) {
                        vm.osType = details.vm.osType;
                        vm.powerState = details.vm.powerState;
                    }
                }
            });
            
            // Redraw the table
            table.draw(false);
        })
        .catch(error => {
            console.error('Error loading VM details:', error);
        });
}

function initializeTable(data) {
    table = $('#instancesTable').DataTable({
        data: data,
        columns: [
            { data: 'name', title: 'Name' },
            { data: 'resourceGroup', title: 'Resource Group' },
            { data: 'location', title: 'Location' },
            { data: 'vmSize', title: 'Size' },
            { data: 'powerState', title: 'State' },
            { 
                data: 'privateIp',
                title: 'Private IP',
                defaultContent: 'Loading...'
            },
            { 
                data: 'publicIp',
                title: 'Public IP',
                defaultContent: 'Loading...'
            }
        ],
        pageLength: perPage,
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
             '<"row"<"col-sm-12"tr>>' +
             '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        language: {
            processing: "Loading...",
            search: "Filter:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "Showing 0 to 0 of 0 entries",
            infoFiltered: "(filtered from _MAX_ total entries)",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });
    
    // Handle pagination clicks
    $('#pagination').on('click', 'a.page-link', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        if (page >= 1 && page <= totalPages) {
            loadVMs(page);
        }
    });
}

function showLoading() {
    $('#loadingOverlay').show();
}

function hideLoading() {
    $('#loadingOverlay').hide();
}

function showError(message) {
    $('#errorAlert').text(message).show();
    setTimeout(() => $('#errorAlert').fadeOut(), 5000);
}

$(document).ready(function() {
    loadVMs();
    
    // Refresh button
    $('#refreshBtn').click(function() {
        loadVMs(currentPage);
    });
    
    // VM details
    $(document).on('click', '#instancesTable tbody tr', function() {
        const vm = table.row(this).data();
        updateVMDetails(vm);
    });
});
</script>
{% endblock %}
