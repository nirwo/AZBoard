{% extends "base.html" %}

{% block additional_styles %}
<style>
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .filter-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .filter-badge .close {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card" data-filter="all">
                <div class="card-body">
                    <h5 class="card-title">Total Instances</h5>
                    <h2 class="total-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="running">
                <div class="card-body">
                    <h5 class="card-title">Running Instances</h5>
                    <h2 class="running-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="resource-groups">
                <div class="card-body">
                    <h5 class="card-title">Resource Groups</h5>
                    <h2 class="resource-groups">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Resource Group</label>
                    <select class="form-select" id="resourceGroupFilter">
                        <option value="">All Resource Groups</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped</option>
                        <option value="deallocated">Deallocated</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>VM Size</label>
                    <select class="form-select" id="vmSizeFilter">
                        <option value="">All Sizes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Actions</label>
                    <div class="d-flex">
                        <button class="btn btn-primary me-2 flex-grow-1" id="applyFilters">
                            Apply Filters
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="clearFilters">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div id="activeFilters"></div>
            </div>
        </div>
    </div>

    <!-- Instances Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">Azure Instances</h5>
                <div>
                    <span class="me-3">Total Monthly Cost: <strong class="total-cost">$0.00</strong></span>
                    <button class="btn btn-primary refresh-btn" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="instancesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Resource Group</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Network</th>
                            <th>Storage</th>
                            <th>Location</th>
                            <th>Monthly Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="vm-details"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let table;
let activeFilters = {};

function updateActiveFilters() {
    const $container = $('#activeFilters');
    $container.empty();
    
    Object.entries(activeFilters).forEach(([key, value]) => {
        if (value) {
            const badge = `
                <span class="filter-badge">
                    ${key}: ${value}
                    <span class="close" data-filter="${key}">Ã—</span>
                </span>
            `;
            $container.append(badge);
        }
    });
}

function formatNetworkInfo(nics) {
    if (!nics || !nics.length) return 'No network interfaces';
    return nics.map(nic => `
        <div class="small mb-2">
            <strong>${nic.name}</strong>
            ${nic.status === 'No IP configuration' ? 
                `<span class="badge bg-warning">No IP Configuration</span>` :
                `<br>
                <i class="fas fa-network-wired"></i> VNet: ${nic.vnet}<br>
                <i class="fas fa-project-diagram"></i> Subnet: ${nic.subnet}<br>
                <i class="fas fa-laptop-house"></i> Private IP: ${nic.private_ip}<br>
                <i class="fas fa-globe"></i> Public IP: ${nic.public_ip}`
            }
        </div>
    `).join('');
}

function formatStorageInfo(disks) {
    if (!disks || !disks.length) return 'No disks';
    return disks.map(disk => `
        <div class="small mb-2">
            <strong>${disk.name}</strong><br>
            Size: ${disk.size_gb}GB<br>
            Type: ${disk.type}<br>
            ${disk.is_os_disk ? '<span class="badge bg-info">OS Disk</span>' : '<span class="badge bg-secondary">Data Disk</span>'}
        </div>
    `).join('');
}

function formatCost(cost) {
    return `$${cost.toFixed(2)}`;
}

function loadData() {
    startLoadingAnimation();
    
    // Build query parameters
    const params = new URLSearchParams();
    Object.entries(activeFilters).forEach(([key, value]) => {
        if (value) params.append(key, value);
    });
    
    $.get(`/api/instances?${params.toString()}`)
        .then(data => {
            if (data.error) {
                showToast(data.error, 'danger');
                return;
            }
            
            // Update stats
            $('.total-instances').text(data.totalCount);
            $('.running-instances').text(
                data.instances.filter(i => i.status.toLowerCase().includes('running')).length
            );
            $('.resource-groups').text(
                new Set(data.instances.map(i => i.resourceGroup)).size
            );
            $('.total-cost').text(formatCost(data.total_monthly_cost));
            
            // Update filters
            const resourceGroups = [...new Set(data.instances.map(i => i.resourceGroup))];
            const vmSizes = [...new Set(data.instances.map(i => i.size))];
            
            $('#resourceGroupFilter').find('option:gt(0)').remove();
            resourceGroups.forEach(rg => {
                $('#resourceGroupFilter').append(`<option value="${rg}">${rg}</option>`);
            });
            
            $('#vmSizeFilter').find('option:gt(0)').remove();
            vmSizes.forEach(size => {
                $('#vmSizeFilter').append(`<option value="${size}">${size}</option>`);
            });
            
            // Update table
            if (table) {
                table.clear().rows.add(data.instances).draw();
            } else {
                table = $('#instancesTable').DataTable({
                    data: data.instances,
                    columns: [
                        { data: 'name' },
                        { data: 'resourceGroup' },
                        {
                            data: 'status',
                            render: function(data) {
                                const status = data.toLowerCase();
                                let className = 'status-unknown';
                                if (status.includes('running')) className = 'status-running';
                                else if (status.includes('stopped') || status.includes('deallocated')) className = 'status-stopped';
                                return `<span class="status-badge ${className}">${data}</span>`;
                            }
                        },
                        { data: 'size' },
                        {
                            data: 'nics',
                            render: formatNetworkInfo
                        },
                        {
                            data: 'disks',
                            render: formatStorageInfo
                        },
                        { data: 'location' },
                        {
                            data: 'monthly_cost',
                            render: formatCost
                        },
                        {
                            data: null,
                            render: function(data) {
                                const status = data.status.toLowerCase();
                                const startBtn = `<button class="btn btn-sm btn-success me-1" onclick="startVM('${data.name}', '${data.resourceGroup}')"><i class="fas fa-play"></i></button>`;
                                const stopBtn = `<button class="btn btn-sm btn-danger me-1" onclick="stopVM('${data.name}', '${data.resourceGroup}')"><i class="fas fa-stop"></i></button>`;
                                const restartBtn = `<button class="btn btn-sm btn-warning" onclick="restartVM('${data.name}', '${data.resourceGroup}')"><i class="fas fa-sync"></i></button>`;
                                
                                return `<div class="btn-group">
                                    ${status.includes('running') ? stopBtn + restartBtn : startBtn}
                                </div>`;
                            }
                        }
                    ],
                    responsive: true,
                    dom: 'Bfrtip',
                    buttons: ['copy', 'excel', 'pdf'],
                    order: [[0, 'asc']]
                });
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            showToast('Failed to load instance data', 'danger');
        })
        .finally(() => {
            stopLoadingAnimation();
        });
}

// VM control functions
function startVM(name, resourceGroup) {
    if (!confirm(`Are you sure you want to start VM "${name}"?`)) return;
    
    $.post('/api/vm/start', { name, resourceGroup })
        .then(response => {
            if (response.error) {
                showToast(response.error, 'danger');
            } else {
                showToast(`Starting VM "${name}"...`, 'success');
                setTimeout(loadData, 5000);
            }
        })
        .catch(error => {
            showToast('Failed to start VM', 'danger');
        });
}

function stopVM(name, resourceGroup) {
    if (!confirm(`Are you sure you want to stop VM "${name}"?`)) return;
    
    $.post('/api/vm/stop', { name, resourceGroup })
        .then(response => {
            if (response.error) {
                showToast(response.error, 'danger');
            } else {
                showToast(`Stopping VM "${name}"...`, 'success');
                setTimeout(loadData, 5000);
            }
        })
        .catch(error => {
            showToast('Failed to stop VM', 'danger');
        });
}

function restartVM(name, resourceGroup) {
    if (!confirm(`Are you sure you want to restart VM "${name}"?`)) return;
    
    $.post('/api/vm/restart', { name, resourceGroup })
        .then(response => {
            if (response.error) {
                showToast(response.error, 'danger');
            } else {
                showToast(`Restarting VM "${name}"...`, 'success');
                setTimeout(loadData, 5000);
            }
        })
        .catch(error => {
            showToast('Failed to restart VM', 'danger');
        });
}

function updateVMDetails(vm) {
    const vmName = vm.name;
    const resourceGroup = vm.resourceGroup;
    
    // Show loading state
    document.getElementById('vm-details').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Loading VM Details...</h5>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <div id="basic-info">Loading basic information...</div>
                <div id="network-info">Loading network information...</div>
                <div id="storage-info">Loading storage information...</div>
            </div>
        </div>
    `;
    
    // Update progress bar
    const progressBar = document.querySelector('.progress-bar');
    
    // Load basic info
    fetch(`/api/vm-basic/${resourceGroup}/${vmName}`)
        .then(response => response.json())
        .then(data => {
            progressBar.style.width = '33%';
            const basicInfo = data.vm;
            document.getElementById('basic-info').innerHTML = `
                <h6>Basic Information</h6>
                <p><strong>Name:</strong> ${basicInfo.name}</p>
                <p><strong>Resource Group:</strong> ${basicInfo.resourceGroup}</p>
                <p><strong>Location:</strong> ${basicInfo.location}</p>
                <p><strong>Size:</strong> ${basicInfo.vmSize}</p>
                <p><strong>OS Type:</strong> ${basicInfo.osType}</p>
                <p><strong>State:</strong> ${basicInfo.provisioningState}</p>
            `;
        })
        .catch(error => {
            document.getElementById('basic-info').innerHTML = `<div class="alert alert-danger">Error loading basic information: ${error}</div>`;
        });
    
    // Load network info
    fetch(`/api/vm-network/${resourceGroup}/${vmName}`)
        .then(response => response.json())
        .then(data => {
            progressBar.style.width = '66%';
            const networkHtml = data.nics.map(nic => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6>${nic.name}</h6>
                        <p><strong>Private IP:</strong> ${nic.private_ip}</p>
                        <p><strong>Public IP:</strong> ${nic.public_ip}</p>
                        <p><strong>Status:</strong> ${nic.status}</p>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('network-info').innerHTML = `
                <h6>Network Information</h6>
                ${networkHtml}
            `;
        })
        .catch(error => {
            document.getElementById('network-info').innerHTML = `<div class="alert alert-danger">Error loading network information: ${error}</div>`;
        });
    
    // Load storage info
    fetch(`/api/vm-storage/${resourceGroup}/${vmName}`)
        .then(response => response.json())
        .then(data => {
            progressBar.style.width = '100%';
            const storageHtml = data.disks.map(disk => `
                <div class="card mb-2">
                    <div class="card-body">
                        <h6>${disk.name}</h6>
                        <p><strong>Size:</strong> ${disk.size_gb} GB</p>
                        <p><strong>Type:</strong> ${disk.type}</p>
                        <p><strong>Role:</strong> ${disk.is_os_disk ? 'OS Disk' : 'Data Disk'}</p>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('storage-info').innerHTML = `
                <h6>Storage Information</h6>
                ${storageHtml}
            `;
            
            // Remove progress bar after everything is loaded
            setTimeout(() => {
                document.querySelector('.progress').remove();
            }, 500);
        })
        .catch(error => {
            document.getElementById('storage-info').innerHTML = `<div class="alert alert-danger">Error loading storage information: ${error}</div>`;
        });
}

$(document).ready(function() {
    // Initialize filters
    $('#applyFilters').click(function() {
        activeFilters = {
            resource_group: $('#resourceGroupFilter').val(),
            status: $('#statusFilter').val(),
            vm_size: $('#vmSizeFilter').val()
        };
        updateActiveFilters();
        loadData();
    });
    
    $('#clearFilters').click(function() {
        activeFilters = {};
        $('#resourceGroupFilter, #statusFilter, #vmSizeFilter').val('');
        updateActiveFilters();
        loadData();
    });
    
    $(document).on('click', '.filter-badge .close', function() {
        const filter = $(this).data('filter');
        activeFilters[filter] = '';
        $(`#${filter}Filter`).val('');
        updateActiveFilters();
        loadData();
    });
    
    // Stats card filtering
    $('.stats-card').click(function() {
        const filter = $(this).data('filter');
        if (filter === 'all') {
            $('#clearFilters').click();
        } else if (filter === 'running') {
            $('#statusFilter').val('running');
            $('#applyFilters').click();
        }
    });
    
    // Initial load
    if (checkAzureLogin()) {
        loadData();
    }
    
    // Refresh button
    $('#refreshBtn').click(function() {
        loadData();
    });
    
    // VM details
    $(document).on('click', '#instancesTable tbody tr', function() {
        const vm = table.row(this).data();
        updateVMDetails(vm);
    });
});
</script>
{% endblock %}
