{% extends "base.html" %}

{% block additional_styles %}
<style>
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 1rem;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .filter-badge {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        display: inline-flex;
        align-items: center;
    }

    .filter-badge .close {
        margin-left: 0.5rem;
        cursor: pointer;
    }

    .stats-card {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        cursor: pointer;
        overflow: hidden;
        position: relative;
    }
    
    #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        z-index: 1000;
    }

    .loading-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    #errorAlert {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card" data-filter="all">
                <div class="card-body">
                    <h5 class="card-title">Total Instances</h5>
                    <h2 class="total-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="running">
                <div class="card-body">
                    <h5 class="card-title">Running Instances</h5>
                    <h2 class="running-instances">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card" data-filter="resource-groups">
                <div class="card-body">
                    <h5 class="card-title">Resource Groups</h5>
                    <h2 class="resource-groups">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Resource Group</label>
                    <select class="form-select" id="resourceGroupFilter">
                        <option value="">All Resource Groups</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Status</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="running">Running</option>
                        <option value="stopped">Stopped</option>
                        <option value="deallocated">Deallocated</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>VM Size</label>
                    <select class="form-select" id="vmSizeFilter">
                        <option value="">All Sizes</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="filter-group">
                    <label>Actions</label>
                    <div class="d-flex">
                        <button class="btn btn-primary me-2 flex-grow-1" id="applyFilters">
                            Apply Filters
                        </button>
                        <button class="btn btn-secondary flex-grow-1" id="clearFilters">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <div id="activeFilters"></div>
            </div>
        </div>
    </div>

    <!-- Instances Table -->
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">Azure Instances</h5>
                <div>
                    <span class="me-3">Total Monthly Cost: <strong class="total-cost">$0.00</strong></span>
                    <button class="btn btn-primary refresh-btn" id="refreshButton">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="instancesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Resource Group</th>
                            <th>Status</th>
                            <th>Size</th>
                            <th>Network</th>
                            <th>Storage</th>
                            <th>Location</th>
                            <th>Monthly Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="vm-details"></div>
    
    <div id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>

    <div id="errorAlert" class="alert alert-danger" role="alert"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let instancesTable = null;

function loadVMs(forceRefresh = false) {
    showLoading();
    
    $.ajax({
        url: '/api/vms',
        data: {
            force_refresh: forceRefresh,
            resource_group: $('#resourceGroupFilter').val(),
            status: $('#statusFilter').val(),
            vm_size: $('#vmSizeFilter').val()
        },
        success: function(response) {
            if (response.error) {
                showError(response.error);
                return;
            }
            
            if (instancesTable) {
                instancesTable.destroy();
            }

            // Update stats
            $('.total-instances').text(response.total);
            $('.running-instances').text(response.vms.filter(vm => vm.powerState === 'running').length);
            $('.resource-groups').text(new Set(response.vms.map(vm => vm.resourceGroup)).size);

            // Initialize DataTable
            instancesTable = $('#instancesTable').DataTable({
                data: response.vms,
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                language: {
                    search: "Search VMs:",
                    lengthMenu: "Show _MENU_ VMs per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ VMs"
                },
                columns: [
                    { data: 'name' },
                    { data: 'resourceGroup' },
                    { 
                        data: 'powerState',
                        render: function(data) {
                            const status = data || 'unknown';
                            const statusClass = {
                                'running': 'success',
                                'stopped': 'warning',
                                'deallocated': 'danger',
                                'unknown': 'secondary'
                            }[status] || 'secondary';
                            
                            return `<span class="badge bg-${statusClass}">${status}</span>`;
                        }
                    },
                    { data: 'vmSize' },
                    { 
                        data: null,
                        render: function(data) {
                            return `<button class="btn btn-sm btn-outline-primary view-network" data-vm="${data.name}" data-rg="${data.resourceGroup}">
                                View Network
                            </button>`;
                        }
                    },
                    { 
                        data: null,
                        render: function(data) {
                            return `<button class="btn btn-sm btn-outline-primary view-storage" data-vm="${data.name}" data-rg="${data.resourceGroup}">
                                View Storage
                            </button>`;
                        }
                    },
                    { data: 'location' },
                    { 
                        data: null,
                        render: function(data) {
                            return `$${data.monthlyCost || 0}`;
                        }
                    },
                    {
                        data: null,
                        render: function(data) {
                            return `<div class="btn-group">
                                <button class="btn btn-sm btn-primary start-stop-vm" data-vm="${data.name}" data-rg="${data.resourceGroup}" data-action="${data.powerState === 'running' ? 'stop' : 'start'}">
                                    ${data.powerState === 'running' ? 'Stop' : 'Start'}
                                </button>
                                <button class="btn btn-sm btn-info view-details" data-vm="${data.name}" data-rg="${data.resourceGroup}">
                                    Details
                                </button>
                            </div>`;
                        }
                    }
                ]
            });

            // Calculate total cost
            const totalCost = response.vms.reduce((sum, vm) => sum + (vm.monthlyCost || 0), 0);
            $('.total-cost').text(`$${totalCost.toFixed(2)}`);
        },
        error: function(xhr, status, error) {
            showError('Failed to load VMs: ' + error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

function showLoading() {
    $('#loadingOverlay').show();
}

function hideLoading() {
    $('#loadingOverlay').hide();
}

function showError(message) {
    const alert = $('#errorAlert');
    alert.text(message).fadeIn();
    setTimeout(() => alert.fadeOut(), 5000);
}

$(document).ready(function() {
    loadVMs();
    
    // Refresh button
    $('#refreshButton').click(function() {
        loadVMs(true);
    });
    
    // Filter buttons
    $('#applyFilters').click(function() {
        loadVMs();
    });
    
    $('#clearFilters').click(function() {
        $('select.filter').val('');
        loadVMs();
    });
});
</script>
{% endblock %}
